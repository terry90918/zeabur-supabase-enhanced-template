apiVersion: zeabur.com/v1
kind: Template
metadata:
  name: Supabase (Enhanced)
spec:
  description: é–‹æº Firebase æ›¿ä»£æ–¹æ¡ˆï¼Œæä¾›å®Œæ•´çš„å¾Œç«¯æœå‹™åŒ…æ‹¬è³‡æ–™åº«ã€èº«ä»½é©—è­‰ã€å³æ™‚ API å’Œå„²å­˜
  icon: https://raw.githubusercontent.com/zeabur/service-icons/main/marketplace/supabase.svg
  coverImage: https://supabase.com/_next/image?url=%2Fimages%2Fproduct%2Fdatabase%2Fheader--dark.png&w=1200&q=75
  variables:
    - key: SUPABASE_DOMAIN
      type: DOMAIN
      name: Supabase ç¶²åŸŸ
      description: æ‚¨æƒ³è¦ç‚º Supabase Studio è¨­å®šä»€éº¼ç¶²åŸŸï¼Ÿ
    - key: ADMIN_USERNAME
      type: STRING
      name: ç®¡ç†å“¡ç”¨æˆ¶å
      description: Supabase Studio çš„ç®¡ç†å“¡ç”¨æˆ¶å
    - key: ADMIN_PASSWORD
      type: STRING
      name: ç®¡ç†å“¡å¯†ç¢¼
      description: Supabase Studio çš„ç®¡ç†å“¡å¯†ç¢¼ï¼ˆå»ºè­°ä½¿ç”¨å¼·å¯†ç¢¼ï¼‰
    - key: ANON_KEY
      type: STRING
      name: åŒ¿åé‡‘é‘°
      description: ç”¨æ–¼åŒ¿åå­˜å–çš„ JWT é‡‘é‘°
    - key: SERVICE_ROLE_KEY
      type: STRING
      name: æœå‹™è§’è‰²é‡‘é‘°
      description: ç”¨æ–¼æœå‹™é–“é€šè¨Šçš„ JWT é‡‘é‘°
  tags:
    - Database
    - Backend
    - API
    - Authentication
    - Realtime
  readme: |
    # Supabase

    Supabase æ¨¡æ¿ï¼Œå°ˆç‚ºä¼æ¥­ç´šéƒ¨ç½²è¨­è¨ˆï¼Œæä¾›å®Œæ•´çš„ä¸­æ–‡åŒ–æ”¯æ´å’Œæœ€ä½³å¯¦è¸é…ç½®ã€‚

    ## ğŸš€ æ ¸å¿ƒåŠŸèƒ½

    - **PostgreSQL è³‡æ–™åº«**: å®Œæ•´çš„ Postgres 17.4 è³‡æ–™åº«
    - **èº«ä»½é©—è­‰**: GoTrue å¤šæä¾›å•†èº«ä»½é©—è­‰
    - **å³æ™‚ API**: PostgREST è‡ªå‹•ç”Ÿæˆ API
    - **å³æ™‚è¨‚é–±**: Realtime å³æ™‚è³‡æ–™åŒæ­¥
    - **æª”æ¡ˆå„²å­˜**: MinIO + Storage API
    - **ç®¡ç†å„€è¡¨æ¿**: Supabase Studio
    - **API Gateway**: Kong åå‘ä»£ç†

    ## ğŸ“¦ æœå‹™æ¶æ§‹

    æ­¤æ¨¡æ¿åŒ…å«å®Œæ•´çš„ Supabase å †ç–Šï¼š
    - Kong (API Gateway)
    - Studio (ç®¡ç†å„€è¡¨æ¿)
    - Database (PostgreSQL 17.4)
    - Meta (PostgreSQL API)
    - REST (PostgREST API)
    - Auth (GoTrue èº«ä»½é©—è­‰)
    - Storage (æª”æ¡ˆå„²å­˜)
    - MinIO (ç‰©ä»¶å„²å­˜)
    - Realtime (å³æ™‚æœå‹™)

    ## ğŸ”§ éƒ¨ç½²å¾Œè¨­å®š

    1. ä½¿ç”¨ç®¡ç†å“¡æ†‘è­‰ç™»å…¥ Studio
    2. å»ºç«‹æ‚¨çš„è³‡æ–™åº«çµæ§‹
    3. é…ç½®èº«ä»½é©—è­‰æä¾›å•†
    4. è¨­å®š API æ¬Šé™å’Œ RLS

    ## ğŸ”’ å®‰å…¨ç‰¹æ€§

    - JWT é‡‘é‘°ç®¡ç†
    - è§’è‰²æ¬Šé™æ§åˆ¶
    - API é‡‘é‘°èªè­‰
    - è¡Œç´šå®‰å…¨æ€§ (RLS)

  services:
  # PostgreSQL è³‡æ–™åº«
  - name: Database
    icon: https://raw.githubusercontent.com/zeabur/service-icons/main/marketplace/postgresql.svg
    template: PREBUILT
    spec:
      source:
        image: supabase/postgres:15.8.1.060
      ports:
        - id: database
          port: 5432
          type: TCP
      volumes:
        - id: postgres-data
          dir: /var/lib/postgresql/data
      env:
        POSTGRES_DB:
          default: postgres
          expose: true
          readonly: true
        POSTGRES_USER:
          default: supabase_admin
          expose: true
          readonly: true
        POSTGRES_PASSWORD:
          default: ${PASSWORD}
          expose: true
        POSTGRES_HOST:
          default: ${CONTAINER_HOSTNAME}
          expose: true
          readonly: true
        POSTGRES_PORT:
          default: ${DATABASE_PORT}
          expose: true
          readonly: true
        JWT_SECRET:
          default: ${PASSWORD}
          expose: true

  # Meta API
  - name: Meta
    icon: https://raw.githubusercontent.com/zeabur/service-icons/main/marketplace/supabase.svg
    template: PREBUILT
    dependencies:
      - Database
    spec:
      source:
        image: supabase/postgres-meta:v0.89.3
      ports:
        - id: meta
          port: 8080
          type: HTTP
      env:
        PG_META_PORT:
          default: "8080"
          readonly: true
        PG_META_DB_HOST:
          default: ${POSTGRES_HOST}
          readonly: true
        PG_META_DB_PORT:
          default: ${POSTGRES_PORT}
          readonly: true
        PG_META_DB_NAME:
          default: ${POSTGRES_DB}
          readonly: true
        PG_META_DB_USER:
          default: ${POSTGRES_USER}
          readonly: true
        PG_META_DB_PASSWORD:
          default: ${POSTGRES_PASSWORD}
          readonly: true

  # PostgREST API
  - name: REST
    icon: https://raw.githubusercontent.com/zeabur/service-icons/main/marketplace/supabase.svg
    template: PREBUILT
    dependencies:
      - Database
    spec:
      source:
        image: postgrest/postgrest:v12.2.12
      ports:
        - id: rest
          port: 3000
          type: HTTP
      env:
        PGRST_DB_URI:
          default: postgresql://authenticator:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/postgres
          readonly: true
        PGRST_DB_SCHEMAS:
          default: public
          readonly: true
        PGRST_DB_ANON_ROLE:
          default: anon
          readonly: true
        PGRST_JWT_SECRET:
          default: ${JWT_SECRET}
          readonly: true

  # GoTrue èº«ä»½é©—è­‰
  - name: Auth
    icon: https://raw.githubusercontent.com/zeabur/service-icons/main/marketplace/supabase.svg
    template: PREBUILT
    dependencies:
      - Database
    spec:
      source:
        image: supabase/gotrue:v2.176.1
      ports:
        - id: auth
          port: 9999
          type: HTTP
      env:
        GOTRUE_API_HOST:
          default: 0.0.0.0
          readonly: true
        GOTRUE_API_PORT:
          default: "9999"
          readonly: true
        GOTRUE_DB_DRIVER:
          default: postgres
          readonly: true
        GOTRUE_DB_DATABASE_URL:
          default: postgresql://supabase_auth_admin:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/postgres
          readonly: true
        GOTRUE_SITE_URL:
          default: https://${SUPABASE_DOMAIN}
          readonly: true
        GOTRUE_JWT_SECRET:
          default: ${JWT_SECRET}
          readonly: true

  # MinIO ç‰©ä»¶å„²å­˜
  - name: MinIO
    icon: https://raw.githubusercontent.com/zeabur/service-icons/main/marketplace/minio.svg
    template: PREBUILT
    spec:
      source:
        image: minio/minio:RELEASE.2025-01-01T22-49-24Z
      ports:
        - id: api
          port: 9000
          type: HTTP
      volumes:
        - id: minio-data
          dir: /data
      env:
        MINIO_ROOT_USER:
          default: supabase
          expose: true
          readonly: true
        MINIO_ROOT_PASSWORD:
          default: ${PASSWORD}
          expose: true
      command:
        - server
        - /data

  # Storage API
  - name: Storage
    icon: https://raw.githubusercontent.com/zeabur/service-icons/main/marketplace/supabase.svg
    template: PREBUILT
    dependencies:
      - Database
      - MinIO
    spec:
      source:
        image: supabase/storage-api:v1.24.7
      ports:
        - id: storage
          port: 5000
          type: HTTP
      env:
        ANON_KEY:
          default: ${ANON_KEY}
          readonly: true
        SERVICE_KEY:
          default: ${SERVICE_ROLE_KEY}
          readonly: true
        DATABASE_URL:
          default: postgresql://supabase_storage_admin:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/postgres
          readonly: true
        STORAGE_BACKEND:
          default: s3
          readonly: true
        AWS_ACCESS_KEY_ID:
          default: ${MINIO_ROOT_USER}
          readonly: true
        AWS_SECRET_ACCESS_KEY:
          default: ${MINIO_ROOT_PASSWORD}
          readonly: true
        AWS_ENDPOINT_URL_S3:
          default: http://MinIO:9000
          readonly: true

  # Realtime æœå‹™
  - name: Realtime
    icon: https://raw.githubusercontent.com/zeabur/service-icons/main/marketplace/supabase.svg
    template: PREBUILT
    dependencies:
      - Database
    spec:
      source:
        image: supabase/realtime:v2.34.47
      ports:
        - id: realtime
          port: 4000
          type: HTTP
      env:
        PORT:
          default: "4000"
          readonly: true
        DB_HOST:
          default: ${POSTGRES_HOST}
          readonly: true
        DB_PORT:
          default: ${POSTGRES_PORT}
          readonly: true
        DB_USER:
          default: supabase_admin
          readonly: true
        DB_PASSWORD:
          default: ${POSTGRES_PASSWORD}
          readonly: true
        DB_NAME:
          default: ${POSTGRES_DB}
          readonly: true
        API_JWT_SECRET:
          default: ${JWT_SECRET}
          readonly: true

  # Kong API Gateway
  - name: Kong
    icon: https://raw.githubusercontent.com/zeabur/service-icons/main/marketplace/kong.svg
    template: PREBUILT
    domainKey: SUPABASE_DOMAIN
    dependencies:
      - Database
      - Meta
      - REST
      - Auth
      - Storage
      - Realtime
    spec:
      source:
        image: kong:2.8.1
      ports:
        - id: proxy
          port: 8000
          type: HTTP
      env:
        KONG_DATABASE:
          default: "off"
          readonly: true
        KONG_DECLARATIVE_CONFIG:
          default: /var/lib/kong/kong.yml
          readonly: true
        KONG_PLUGINS:
          default: request-transformer,cors,key-auth,acl,basic-auth
          readonly: true
        ANON_KEY:
          default: ${ANON_KEY}
          expose: true
          readonly: true
        SERVICE_ROLE_KEY:
          default: ${SERVICE_ROLE_KEY}
          expose: true
          readonly: true
        DASHBOARD_USERNAME:
          default: ${ADMIN_USERNAME}
          readonly: true
        DASHBOARD_PASSWORD:
          default: ${ADMIN_PASSWORD}
          readonly: true
      configs:
        - path: /var/lib/kong/kong.yml
          template: |
            _format_version: "3.0"
            _transform: true
            consumers:
              - username: anon
                keyauth_credentials:
                  - key: ${ANON_KEY}
              - username: service_role
                keyauth_credentials:
                  - key: ${SERVICE_ROLE_KEY}
              - username: DASHBOARD
            basicauth_credentials:
              - consumer: DASHBOARD
                username: ${DASHBOARD_USERNAME}
                password: ${DASHBOARD_PASSWORD}
            acls:
              - consumer: anon
                group: anon
              - consumer: service_role
                group: anon
              - consumer: service_role
                group: service_role
            services:
              - name: auth-v1
                url: http://Auth:9999/
                plugins:
                  - name: cors
                  - name: key-auth
                    config:
                      hide_credentials: false
                  - name: acl
                    config:
                      hide_groups_header: true
                      allow:
                        - anon
                        - service_role
              - name: rest-v1
                url: http://REST:3000/
                plugins:
                  - name: cors
                  - name: key-auth
                    config:
                      hide_credentials: true
                  - name: acl
                    config:
                      hide_groups_header: true
                      allow:
                        - anon
                        - service_role
              - name: realtime-v1
                url: http://Realtime:4000/socket/
                plugins:
                  - name: cors
                  - name: key-auth
                    config:
                      hide_credentials: false
                  - name: acl
                    config:
                      hide_groups_header: true
                      allow:
                        - anon
                        - service_role
              - name: storage-v1
                url: http://Storage:5000/
                plugins:
                  - name: cors
              - name: meta-v1
                url: http://Meta:8080/
                plugins:
                  - name: cors
                  - name: key-auth
                    config:
                      hide_credentials: true
                  - name: acl
                    config:
                      hide_groups_header: true
                      allow:
                        - service_role
            routes:
              - service: auth-v1
                paths:
                  - "~/auth/v1/"
                strip_path: true
              - service: rest-v1
                paths:
                  - "~/rest/v1/"
                strip_path: true
              - service: realtime-v1
                paths:
                  - "~/realtime/v1/"
                strip_path: true
              - service: storage-v1
                paths:
                  - "~/storage/v1/"
                strip_path: true
              - service: meta-v1
                paths:
                  - "~/pg/"
                strip_path: true
          envsubst: true

  # Supabase Studio
  - name: Studio
    icon: https://raw.githubusercontent.com/zeabur/service-icons/main/marketplace/supabase.svg
    template: PREBUILT
    dependencies:
      - Kong
    spec:
      source:
        image: supabase/studio:2025.06.30-sha-6f5982d
      ports:
        - id: studio
          port: 3000
          type: HTTP
      env:
        STUDIO_PG_META_URL:
          default: http://Kong:8000/pg
          readonly: true
        SUPABASE_URL:
          default: http://Kong:8000
          readonly: true
        SUPABASE_ANON_KEY:
          default: ${ANON_KEY}
          readonly: true
        SUPABASE_SERVICE_KEY:
          default: ${SERVICE_ROLE_KEY}
          readonly: true

localization:
  zh-TW:
    description: é–‹æº Firebase æ›¿ä»£æ–¹æ¡ˆï¼Œå°ˆç‚ºä¼æ¥­ç´šéƒ¨ç½²å„ªåŒ–ï¼Œæä¾›å®Œæ•´ä¸­æ–‡åŒ–æ”¯æ´
    variables:
      - key: SUPABASE_DOMAIN
        type: DOMAIN
        name: Supabase ç¶²åŸŸ
        description: æ‚¨æƒ³è¦ç‚º Supabase Studio è¨­å®šä»€éº¼ç¶²åŸŸï¼Ÿ
      - key: ADMIN_USERNAME
        type: STRING
        name: ç®¡ç†å“¡ç”¨æˆ¶å
        description: Supabase Studio çš„ç®¡ç†å“¡ç”¨æˆ¶å
      - key: ADMIN_PASSWORD
        type: STRING
        name: ç®¡ç†å“¡å¯†ç¢¼
        description: Supabase Studio çš„ç®¡ç†å“¡å¯†ç¢¼ï¼ˆå»ºè­°ä½¿ç”¨å¼·å¯†ç¢¼ï¼‰
      - key: ANON_KEY
        type: STRING
        name: åŒ¿åé‡‘é‘°
        description: ç”¨æ–¼åŒ¿åå­˜å–çš„ JWT é‡‘é‘°
      - key: SERVICE_ROLE_KEY
        type: STRING
        name: æœå‹™è§’è‰²é‡‘é‘°
        description: ç”¨æ–¼æœå‹™é–“é€šè¨Šçš„ JWT é‡‘é‘°
    readme: |
      # Supabase - ä¼æ¥­ç´šç‰ˆæœ¬

      å°ˆç‚ºå°ç£å¸‚å ´è¨­è¨ˆçš„ Supabase æ¨¡æ¿ï¼Œæä¾›å®Œæ•´çš„ä¸­æ–‡åŒ–é«”é©—å’Œä¼æ¥­ç´šé…ç½®ã€‚

      ## ğŸŒŸ å°ç£æœ¬åœ°åŒ–ç‰¹è‰²

      - **å®Œæ•´ä¸­æ–‡åŒ–**: æ‰€æœ‰ä»‹é¢å’Œæ–‡æª”çš„ä¸­æ–‡æ”¯æ´
      - **åœ¨åœ°å„ªåŒ–**: é‡å°å°ç£ç¶²è·¯ç’°å¢ƒå„ªåŒ–çš„é…ç½®
      - **ä¼æ¥­ç´šæ¶æ§‹**: é©åˆå°ç£ä¼æ¥­çš„éƒ¨ç½²æ¶æ§‹
      - **æŠ€è¡“æ”¯æ´**: æä¾›ä¸­æ–‡æŠ€è¡“æ–‡æª”å’Œæ”¯æ´

      ## ğŸš€ å¿«é€Ÿéƒ¨ç½²

      1. è¨­å®šæ‚¨çš„ç¶²åŸŸå’Œç®¡ç†å“¡æ†‘è­‰
      2. ä¸€éµéƒ¨ç½²å®Œæ•´çš„ Supabase å †ç–Š
      3. ç«‹å³é–‹å§‹æ‚¨çš„å°ˆæ¡ˆé–‹ç™¼

      ## ğŸ“ æ”¯æ´èˆ‡å¹«åŠ©

      - [å®˜æ–¹æ–‡æª”](https://supabase.com/docs)
      - [ç¤¾ç¾¤æ”¯æ´](https://github.com/supabase/supabase)
      - [API åƒè€ƒ](https://supabase.com/docs/reference)